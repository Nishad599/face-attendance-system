<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Your Page Title</title>

    <!-- Fonts & your external stylesheet (kept as-is) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">

    <style>
        /* ===== Base ===== */
        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        /* Space for fixed header on desktop */
        body {
            padding-top: 90px !important;
        }

        /* ===== CDAC NAVBAR (About Us style) ===== */
        .cdac-header {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-bottom: 4px solid #0066cc;
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.15);
            position: fixed;
            top: 0; left: 0; right: 0;
            width: 100%;
            z-index: 10000;
            padding: 12px 0;
        }
        .cdac-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            padding: 0 24px;
        }

        /* Logo + text */
        .cdac-logo-section {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }
        .cdac-logo-wrapper {
            background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 102, 204, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
            min-height: 60px;
            position: relative;
        }
        .cdac-logo-img {
            height: 50px;
            width: 50px;
            object-fit: contain;
            display: block;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 4px;
        }
        .cdac-fallback-logo {
            display: none;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
        }
        .fallback-icon {
            font-size: 32px;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .cdac-text-section {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .cdac-hindi {
            font-size: 16px;
            font-weight: 700;
            color: #0066cc;
            line-height: 1.2;
            letter-spacing: 0.5px;
        }
        .cdac-english {
            font-size: 13px;
            font-weight: 600;
            color: #004499;
            line-height: 1.2;
            letter-spacing: 0.3px;
        }
        .cdac-tagline {
            font-size: 11px;
            font-weight: 500;
            color: #666;
            line-height: 1.2;
            font-style: italic;
        }

        /* Center nav */
        .cdac-navigation {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 0 0 auto;
        }
        .nav-link {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            white-space: nowrap;
            border: 2px solid transparent;
        }
        .nav-link:hover {
            background: linear-gradient(135deg, #e6f3ff 0%, #cce6ff 100%);
            color: #0066cc;
            border-color: #b3d9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 102, 204, 0.15);
            text-decoration: none;
        }
        .nav-link.active {
            background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
            color: #fff;
            border-color: #0066cc;
        }
        .nav-icon { font-size: 16px; }
        .nav-text { font-size: 13px; letter-spacing: 0.5px; }

        /* Right: Logout button */
        .cdac-user-section { flex: 0 0 auto; }
        .logout-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
            transition: all 0.3s ease;
            letter-spacing: 0.3px;
        }
        .logout-button:hover {
            background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(220, 53, 69, 0.4);
        }

        /* ===== Mobile ===== */
        @media (max-width: 768px) {
            .cdac-header { position: relative; padding: 16px 0; }
            body { padding-top: 0 !important; } /* remove offset when header isn‚Äôt fixed */
            .cdac-container { flex-direction: column; gap: 16px; text-align: center; padding: 0 12px; }
        }
    </style>
</head>
<body>

    <!-- Header (About Us style) -->
    <header class="cdac-header">
        <div class="cdac-container">
            <!-- Left: logo block -->
            <div class="cdac-logo-section">
                <div class="cdac-logo-wrapper">
                    <img src="/static/images/cdac-logo.png" alt="CDAC Logo" class="cdac-logo-img"
                         onerror="this.style.display='none'; document.getElementById('cdac-fallback-logo').style.display='flex';">
                    <div id="cdac-fallback-logo" class="cdac-fallback-logo" style="display:none;">
                        <span class="fallback-icon">üèõÔ∏è</span>
                    </div>
                </div>
                <div class="cdac-text-section">
                    <div class="cdac-hindi">‡§≠‡§æ‡§∞‡§§ ‡§∏‡§Ç‡§ó‡§£‡§® ‡§µ‡§ø‡§ï‡§æ‡§∏ ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞</div>
                    <div class="cdac-english">CENTRE FOR DEVELOPMENT OF ADVANCED COMPUTING</div>
                    <div class="cdac-tagline">Face Recognition Attendance System</div>
                </div>
            </div>

            <!-- Center: nav -->
            <nav class="cdac-navigation">
                <a href="/dashboard" class="nav-link">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-text">HOME</span>
                </a>
                <a href="/about" class="nav-link">
                    <span class="nav-icon">‚ÑπÔ∏è</span>
                    <span class="nav-text">ABOUT</span>
                </a>
                <a href="/contact" class="nav-link">
                    <span class="nav-icon">üìû</span>
                    <span class="nav-text">CONTACT</span>
                </a>
            </nav>

            <!-- Right: logout -->
            <div class="cdac-user-section">
                <button class="logout-button" onclick="performLogout()" title="Logout">
                    <span class="logout-icon">üö™</span>
                    <span class="logout-text">Logout</span>
                </button>
            </div>
        </div>
    </header>

    <!-- ===== Main Registration Content (kept your structure) ===== -->
    <div class="registration-container">
        <div class="header">
            <h1>Student Registration</h1>
            <p>Face Recognition Attendance System</p>
        </div>

        <div class="content">
            <div class="step-indicator">
                <div class="step-dot active" id="step-dot-1">1</div>
                <div class="step-dot" id="step-dot-2">2</div>
                <div class="step-dot" id="step-dot-3">3</div>
                <div class="step-dot" id="step-dot-4">4</div>
            </div>

            <!-- Step 1: Personal Information -->
            <div class="step active" id="step-1">
                <h2>Personal Information</h2>
                <div class="form-group">
                    <label for="student-name">Full Name</label>
                    <input type="text" id="student-name" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="student-email">Email Address</label>
                    <input type="email" id="student-email" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="student-id">Student ID</label>
                    <input type="text" id="student-id" placeholder="Enter your student ID" required>
                </div>
                <button class="btn btn-primary" onclick="nextStep()">Next Step</button>
            </div>

            <!-- Step 2: Camera Setup -->
            <div class="step" id="step-2">
                <h2>Camera Setup</h2>
                <div class="instructions">
                    <h3>üìπ Camera Instructions:</h3>
                    <ul>
                        <li>Position yourself 2-3 feet from the camera</li>
                        <li>Ensure good lighting on your face</li>
                        <li>Look directly at the camera</li>
                        <li>Remove glasses/hat if possible</li>
                    </ul>
                </div>

                <div class="timing-controls">
                    <h4>‚è±Ô∏è Photo Capture Timing:</h4>
                    <div class="timing-option">
                        <input type="radio" id="manual-timing" name="timing" value="manual" checked>
                        <label for="manual-timing">Manual (you click when ready)</label>
                    </div>
                    <div class="timing-option">
                        <input type="radio" id="countdown-3" name="timing" value="3">
                        <label for="countdown-3">3 second countdown</label>
                    </div>
                    <div class="timing-option">
                        <input type="radio" id="countdown-5" name="timing" value="5">
                        <label for="countdown-5">5 second countdown</label>
                    </div>
                </div>

                <div class="video-container">
                    <video id="video-stream" class="video-stream" autoplay></video>
                    <div class="face-overlay"></div>
                    <div class="countdown-overlay" id="countdown-overlay">3</div>
                </div>
                <div id="camera-status" class="status-message status-warning">
                    Click "Start Camera" to begin
                </div>
                <button class="btn btn-primary" onclick="startCamera()">Start Camera</button>
                <button class="btn btn-secondary" onclick="prevStep()">Previous</button>
            </div>

            <!-- Step 3: Face Scanning -->
            <div class="step" id="step-3">
                <h2>Face Scanning</h2>
                {% if face_recognition_available %}
                <div class="instructions">
                    <h3>We need 5 photos of your face:</h3>
                    <ul>
                        <li>Take your time with each photo</li>
                        <li>Follow the instructions for each photo</li>
                        <li>Keep your face in the green outline</li>
                        <li>You can retake any photo if needed</li>
                    </ul>
                </div>

                <div class="current-instruction" id="current-instruction">
                    Look straight ahead at the camera
                </div>

                <div class="video-container">
                    <video id="capture-video" class="video-stream" autoplay></video>
                    <div class="face-overlay"></div>
                    <div class="countdown-overlay" id="capture-countdown">3</div>
                </div>

                <div class="capture-counter">Photos captured: <span id="capture-count">0</span> / 5</div>
                <div class="capture-progress">
                    <div class="progress-dot" id="progress-1"></div>
                    <div class="progress-dot" id="progress-2"></div>
                    <div class="progress-dot" id="progress-3"></div>
                    <div class="progress-dot" id="progress-4"></div>
                    <div class="progress-dot" id="progress-5"></div>
                </div>

                <div id="capture-instructions" class="status-message status-warning">
                    Position your face and click "Take Photo" when ready
                </div>

                <div class="photo-preview" id="photo-preview">
                    <h4>Last photo taken:</h4>
                    <img id="preview-img" alt="Photo preview">
                    <div>
                        <button class="btn btn-success" onclick="acceptPhoto()">‚úÖ Accept</button>
                        <button class="btn btn-warning" onclick="retakePhoto()">üîÑ Retake</button>
                    </div>
                </div>

                <div style="margin: 1rem 0;">
                    <button class="btn btn-success" onclick="capturePhoto()" id="capture-btn">üì∏ Take Photo</button>
                    <button class="btn btn-warning" onclick="skipPhoto()" id="skip-btn" style="display: none;">‚è≠Ô∏è Skip This Photo</button>
                </div>

                {% else %}
                <div class="status-message status-warning">
                    <h3>‚ö†Ô∏è Face Recognition Not Available</h3>
                    <p>Running in basic mode. Face recognition features are disabled.</p>
                    <p>You can still register, but automatic face detection won't work.</p>
                </div>
                <button class="btn btn-primary" onclick="skipFaceCapture()">Continue Without Face Recognition</button>
                {% endif %}
                <button class="btn btn-secondary" onclick="prevStep()">Previous</button>
            </div>

            <!-- Step 4: Completion -->
            <div class="step" id="step-4">
                <h2>Registration Complete!</h2>
                <div class="status-message status-success">
                    <h3>‚úÖ Registration Successful!</h3>
                    <p>Your information has been registered in the attendance system.</p>
                    {% if face_recognition_available %}
                    <p>Face recognition is now active for automatic attendance tracking.</p>
                    {% else %}
                    <p>Basic registration completed. Face recognition can be added later.</p>
                    {% endif %}
                </div>
                <div class="instructions">
                    <h3>What's next?</h3>
                    <ul>
                        <li>Your data is securely stored</li>
                        {% if face_recognition_available %}
                        <li>Attendance will be automatically tracked</li>
                        <li>Visit the Live Attendance page to test recognition</li>
                        {% else %}
                        <li>Manual attendance tracking available</li>
                        {% endif %}
                        <li>Check your attendance in the dashboard</li>
                    </ul>
                </div>
                <button class="btn btn-primary" onclick="goToDashboard()">Go to Dashboard</button>
                <button class="btn btn-secondary" onclick="goToAttendance()">Try Live Attendance</button>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let videoStream = null;
        let capturedPhotos = 0;
        let currentSessionId = null;
        let photoPreviewMode = false;
        let currentPhotoData = null;
        const REQUIRED_PHOTOS = 5;

        const captureInstructions = [
            { text: "Look straight ahead at the camera", description: "Keep your head centered and look directly forward" },
            { text: "Look straight ahead again", description: "Same position, this helps improve accuracy" },
            { text: "Turn your head slightly to the left", description: "About 15-20 degrees, keep your eyes on camera" },
            { text: "Turn your head slightly to the right", description: "About 15-20 degrees, keep your eyes on camera" },
            { text: "Tilt your head slightly up", description: "Slight upward angle, as if looking at something above the camera" }
        ];

        function getTimingSetting() {
            const timing = document.querySelector('input[name="timing"]:checked').value;
            return timing === 'manual' ? 0 : parseInt(timing);
        }

        async function nextStep() {
            if (currentStep === 1) {
                const name = document.getElementById('student-name').value;
                const email = document.getElementById('student-email').value;
                const id = document.getElementById('student-id').value;

                if (!name || !email || !id) { alert('Please fill all fields'); return; }

                try {
                    const response = await fetch('/api/start_registration', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, email, student_id: id })
                    });
                    const result = await response.json();
                    if (result.success) {
                        currentSessionId = result.session_id;
                    } else {
                        alert('Registration failed: ' + result.message);
                        return;
                    }
                } catch (error) {
                    alert('Failed to start registration');
                    return;
                }
            }

            if (currentStep < 4) {
                document.getElementById(`step-${currentStep}`).classList.remove('active');
                document.getElementById(`step-dot-${currentStep}`).classList.add('completed');
                document.getElementById(`step-dot-${currentStep}`).classList.remove('active');

                currentStep++;
                document.getElementById(`step-${currentStep}`).classList.add('active');
                document.getElementById(`step-dot-${currentStep}`).classList.add('active');
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                document.getElementById(`step-${currentStep}`).classList.remove('active');
                document.getElementById(`step-dot-${currentStep}`).classList.remove('active');

                currentStep--;
                document.getElementById(`step-${currentStep}`).classList.add('active');
                document.getElementById(`step-dot-${currentStep}`).classList.remove('completed');
                document.getElementById(`step-dot-${currentStep}`).classList.add('active');
            }
        }

        async function startCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720, facingMode: 'user' }
                });

                document.getElementById('video-stream').srcObject = videoStream;
                document.getElementById('camera-status').innerHTML = '<div class="status-success">‚úÖ Camera ready!</div>';

                setTimeout(() => {
                    nextStep();
                    document.getElementById('capture-video').srcObject = videoStream;
                    updateCaptureInstructions();
                }, 2000);

            } catch (error) {
                document.getElementById('camera-status').innerHTML = '<div class="status-error">‚ùå Camera access denied</div>';
            }
        }

        function updateCaptureInstructions() {
            if (capturedPhotos < REQUIRED_PHOTOS) {
                const instruction = captureInstructions[capturedPhotos];
                document.getElementById('current-instruction').textContent = instruction.text;
                document.getElementById('capture-instructions').innerHTML =
                    `<div class="status-warning">${instruction.description}</div>`;
            } else {
                document.getElementById('current-instruction').textContent = 'All photos captured!';
                document.getElementById('capture-instructions').innerHTML =
                    '<div class="status-success">‚úÖ All photos captured! Processing...</div>';
                document.getElementById('capture-btn').style.display = 'none';
            }
        }

        async function capturePhoto() {
            if (capturedPhotos >= REQUIRED_PHOTOS) return;

            const timingSetting = getTimingSetting();
            if (timingSetting > 0) { await startCountdown(timingSetting); }

            const video = document.getElementById('capture-video');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);

            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            currentPhotoData = imageData;

            // Show preview
            document.getElementById('preview-img').src = imageData;
            document.getElementById('photo-preview').style.display = 'block';
            document.getElementById('capture-btn').style.display = 'none';
            photoPreviewMode = true;

            // Flash effect
            const overlay = document.querySelector('.face-overlay');
            overlay.style.background = 'rgba(76, 175, 80, 0.3)';
            setTimeout(() => overlay.style.background = 'transparent', 200);
        }

        async function startCountdown(seconds) {
            const countdownOverlay = document.getElementById('capture-countdown');
            countdownOverlay.style.display = 'flex';
            for (let i = seconds; i > 0; i--) {
                countdownOverlay.textContent = i;
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            countdownOverlay.textContent = 'üì∏';
            await new Promise(resolve => setTimeout(resolve, 200));
            countdownOverlay.style.display = 'none';
        }

        async function acceptPhoto() {
            if (!currentPhotoData) return;

            try {
                const response = await fetch('/api/upload_face_photo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSessionId, image_data: currentPhotoData })
                });
                const result = await response.json();

                if (result.success) {
                    capturedPhotos++;
                    document.getElementById('capture-count').textContent = capturedPhotos;
                    document.getElementById(`progress-${capturedPhotos}`).classList.add('captured');

                    document.getElementById('photo-preview').style.display = 'none';
                    document.getElementById('capture-btn').style.display = 'inline-block';
                    photoPreviewMode = false;
                    currentPhotoData = null;

                    updateCaptureInstructions();
                    if (capturedPhotos === REQUIRED_PHOTOS) {
                        setTimeout(completeRegistration, 1500);
                    }
                } else {
                    alert('Photo upload failed: ' + result.message);
                    retakePhoto();
                }
            } catch (error) {
                alert('Failed to upload photo');
                retakePhoto();
            }
        }

        function retakePhoto() {
            document.getElementById('photo-preview').style.display = 'none';
            document.getElementById('capture-btn').style.display = 'inline-block';
            photoPreviewMode = false;
            currentPhotoData = null;
        }

        function skipPhoto() {
            if (capturedPhotos >= 3) {
                capturedPhotos++;
                document.getElementById('capture-count').textContent = capturedPhotos;
                document.getElementById(`progress-${capturedPhotos}`).style.background = '#ffc107';
                updateCaptureInstructions();
                if (capturedPhotos === REQUIRED_PHOTOS) {
                    setTimeout(completeRegistration, 1500);
                }
            } else {
                alert('You need at least 3 photos. Please take this photo.');
            }
        }

        async function completeRegistration() {
            try {
                const response = await fetch('/api/complete_registration', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSessionId })
                });
                const result = await response.json();
                if (result.success) {
                    nextStep();
                    stopCamera();
                } else {
                    alert('Registration failed: ' + result.message);
                }
            } catch (error) {
                alert('Registration failed');
            }
        }

        function skipFaceCapture() { nextStep(); }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
        }

        function goToDashboard() { window.location.href = "/dashboard"; }
        function goToAttendance() { window.location.href = '/attendance'; }

        // Show skip after 3 photos
        setInterval(() => {
            const el = document.getElementById('skip-btn');
            if (!el) return;
            if (capturedPhotos >= 3 && capturedPhotos < REQUIRED_PHOTOS) {
                el.style.display = 'inline-block';
            } else {
                el.style.display = 'none';
            }
        }, 1000);

        // Cleanup camera when leaving page
        window.addEventListener("beforeunload", function() {
            fetch("/api/cleanup_camera", { method: "POST" });
        });
        window.addEventListener('beforeunload', stopCamera);
    </script>

    <script>
        // Logout functionality (kept)
        async function performLogout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    const response = await fetch('/api/logout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include'
                    });
                    const result = await response.json();
                    if (result.success) {
                        localStorage.clear();
                        sessionStorage.clear();
                        window.location.href = '/login';
                    } else {
                        alert('Logout failed: ' + result.message);
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                    window.location.href = '/login';
                }
            }
        }

        // Session check (kept)
        async function checkSession() {
            try {
                const response = await fetch('/api/session/status', { credentials: 'include' });
                const result = await response.json();
                if (!result.authenticated) window.location.href = '/login';
            } catch (error) {
                console.log('Session check failed:', error);
            }
        }

        // Periodic checks
        setInterval(checkSession, 5 * 60 * 1000);
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) checkSession();
        });
    </script>
</body>
</html>
